{% extends 'layout.jinja2' %}

{% block header %}
{{ header if header is not none else super() }}
{% endblock %}

{% block content %}
<div class="w3-card-4" style="max-width: 640px; margin: auto; margin-top: 80px">
    <div class="w3-container">
    <h2 class="w3-theme-d2 w3-center">{{ _('Gestione Viaggi') }}</h2>
    </div>
    <form method="POST" enctype="multipart/form-data">
        {{ form.csrf_token }}
        <div class="tooltip form-group">
        {{ form.tour.label(class="w3-theme-l4 w3-left-align wbold required", style="width: 35%") }}
        {{ form.tour(class="w3-left-align w3-input w3-theme-l4", style="width: 55%") }}
        <span class="w3-monospace tooltiptext"></span>

        </div>

        <div class="form-group">
        {{ form.visibility.label(class="w3-theme-l4 w3-left-align wbold required", style="width: 35%") }}
        {{ form.visibility(class="w3-left-align w3-input w3-theme-l4", style="width: 55%") }}
        </div>

        <div class="form-group">
        {{ form.tour_cover.label(class="w3-theme-l4 w3-left-align wbold required", style="width: 35%") }}
        {{ form.tour_cover(class="w3-left-align w3-input w3-theme-l4", style="width: 55%") }}
        </div>

        <div class="form-group">
        {{ form.caption.label(class="w3-theme-l4 w3-left-align wbold required", style="width: 35%") }}
        {{ form.caption(class="w3-left-align w3-input w3-theme-l4", style="width: 55%") }}
        </div>

        <div style="margin-bottom: 20px; margin-top:50px;">
        <p class="w3-center">{{ form.submit(class="w3-button w3-theme-action w3-hover-theme-d2 w3-ripple w3-center", style="width: 30%") }}</p>
        </div>

        <hr class="w3-theme-d3" style="height: 4px;">

        <div id="danger" class="w3-container" style="margin: auto; display: none; width: 70%;">
            <p id="what-danger"></p>
            <div class="w3-bar" style="width: 50%; margin: auto;">
                <p id="no" class="w3-bar-item w3-button w3-theme-action w3-hover-theme-d2 w3-ripple">NO</a>
                <p id="yes" class="w3-bar-item w3-button w3-theme-action w3-hover-theme-d2 w3-ripple w3-right">{{ _('SI') }}</a>
            </div>
        </div>
        <div style="display: none">
            {{ form.submit_del }}
        </div>
    </form>
    <div class="w3-center" style="margin-bottom: 20px; margin-top: 50px;">
    <p id="sure" class="w3-button w3-theme-action w3-hover-theme-d2 w3-ripple w3-center", style="width: 30%")>{{ _('Cancella il viaggio') }}</p>
    </div>
    <p style="visibility:hidden">a</p>
</div>
{% endblock %}

{% block scripts %}
<script>
const form = document.querySelector("form");
form.addEventListener("submit", examineForm);
document.querySelector('#sure').addEventListener("click", beCautious);
document.querySelector("#no").addEventListener("click", (evt) => {
                                            document.querySelector("#danger").style.display = "none";
                                           });

document.querySelector("#yes").addEventListener("click", (evt) => {
                                            document.querySelector("#danger").style.display = "none";
                                            const submitDel = document.querySelector("#submit_del");
                                            submitDel.formAction = {{ url_for('dbms_bp.delete_tour')|tojson }};
                                            form.requestSubmit(submitDel);
                                           });

function beCautious(evt) {
    if (is_valid()) {
        document.querySelector("#danger").style.display = "block";
        const tour_id = document.querySelector('#tour').value;
        const opts = document.querySelector('#tour').options;
        let tour
        for (let opt in opts) {
            if (! opts[opt].value) {
                continue;
            }
            if (opts[opt].value == tour_id) {
                tour = opts[opt].label;
                break;
            }
        }
        const msg = document.querySelector('#what-danger')
        msg.textContent = `La cancellazione del viaggio "${tour}" comporta la cancellazione dei dati relative alle tappe e agli alberghi del viaggio. Sei sicuro di voler continuare?`;
    }
}

const bg_color = getComputedStyle(document.querySelector(":root"));

function examineForm(evt) {
    if (! is_valid()) {
        evt.preventDefault();
    }
}

function is_valid() {
     const tooltip = document.querySelector("#tour ~ span");
    if (! tour.value){
        tooltip.textContent = "{{ _('Viaggio non selezionato') }}";
        tooltip.style.backgroundColor = bg_color.getPropertyValue('--th-l3');
        tooltip.style.display = "block";
        return false;
    } else {
        resetTooltip(tooltip);
        return true;
    }
}

function resetTooltip(tooltip) {
    tooltip.textContent = "";
    tooltip.style.backgroundColor = bg_color.getPropertyValue('--th-l4');
    tooltip.style.display= "none";
}

</script>
{% endblock %}
